version: "3.7"

services:
  rabbitmq:
    image: rabbitmq:3-management
    restart: unless-stopped
    ports:
      - 5672:5672/tcp    # queues
      - 5552:5552/tcp    # streams
      - 15672:15672/tcp  # management
    volumes:
      - rabbitmq:/var/lib/rabbitmq
    hostname: rabbit
    # Uncomment when first run, to seed the default user,
    # then comment back out to avoid credential exposure.
    #env_file: ./.config/rabbitmq.env
    # Also, after its initial setup you need to enable the stream plugins:
    # - docker-compose exec rabbit rabbitmq-plugins enable rabbitmq_stream{,_management}
    # Also also, you might want to disable some plugins we're not using:
    # - docker-compose exec rabbit rabbitmq-plugins disable rabbitmq_{federation,prometheus}

  matrix-sender:
    image: gbenson/hive-matrix-connector
    init: true
    restart: unless-stopped
    volumes:
      - matrix_sender:/var/lib/matrix
      - .config/rabbitmq.env:/etc/hive/rabbitmq.env:ro
    command:
      - hive-matrix-sender
      - --consume=matrix.messages.outgoing

  matrix-receiver:
    image: gbenson/hive-matrix-connector
    init: true
    restart: unless-stopped
    volumes:
      - matrix_receiver:/var/lib/matrix
      - .config/rabbitmq.env:/etc/hive/rabbitmq.env:ro
    command:
      - hive-matrix-receiver

  email-receiver:
    image: gbenson/hive-email-receiver
    init: true
    restart: unless-stopped
    volumes:
      - .config/rabbitmq.env:/etc/hive/rabbitmq.env:ro
      - .config/email.yml:/etc/hive/email.yml:ro
    command:
      - hive-email-receiver

  reading-list-updater:
    image: gbenson/hive-reading-list-updater
    init: true
    restart: unless-stopped
    volumes:
      - .config/rabbitmq.env:/etc/hive/rabbitmq.env:ro
      - .config/mediawiki.yml:/etc/hive/mediawiki.yml:ro
    command:
      - hive-reading-list-updater

volumes:
  matrix_sender:
  matrix_receiver:
  rabbitmq:
